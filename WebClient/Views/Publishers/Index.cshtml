@{
	ViewData["Title"] = "Publishers";
}

<div class="card">
	<div class="card-header">Publishers Panel</div>
	<div class="card-body">
		<div class="row">
			<div class="col-md-12 text-white text-center">
				<button id="btn-refresh" value="getAll" class="btn btn-primary">Refresh</button>
				<button id="btn-create" target="_blank" class="btn btn-secondary">Create New</button>
			</div>
			<div class="col-md-12">
				<form id="form_create">
					<h4>Please fill information below</h4>
					<hr />
					<div class="row">
						<div class="form-group col-lg-4 col-md-6">
							<label for="Name_Create">Name</label>
							<input type="text" class="form-control" id="Name_Create" name="Name" placeholder="Enter Name"/>
						</div>
					
						<div class="form-group col-lg-4 col-md-6">
							<label for="City_Create">City</label>
							<select class="form-control" id="City_Create" name="City" placeholder="Select City">

							</select>
						</div>
						<div class="form-group col-lg-4 col-md-6">
							<label for="State_Update">State</label>
							<select class="form-control" id="State_Create" name="State" placeholder="Select State">

							</select>
						</div>
						<div class="form-group col-lg-4 col-md-6">
							<label for="Country_Update">Country</label>
							<select class="form-control" id="Country_Create" name="Country" placeholder="Select Country">

							</select>
						</div>
						<div class="m-2 col-sm-12 text-center">
							<button type="button" id="form_create_close" class="btn btn-danger">Close</button>
							<button type="submit" class="btn btn-success">Create</button>
						</div>
					</div>
				</form>

			</div>
			<div class="col-md-12">
				<h4>Information</h4>
				<hr />
				<table id="table_items" class="table table-striped table-hover table-md-responsive text-center">
					<thead class="bg-primary text-white">
						<tr>
							<th>Id</th>
							<th>Name</th>
							<th>City</th>
							<th>State</th>
							<th>Country</th>
							<th>...</th>
						</tr>
						<tr id="loading">
							<td colspan="8">
								<div class="spinner-border text-secondary" role="status">
									<span class="sr-only">Loading...</span>
								</div>
							</td>
						</tr>
					</thead>
					<tbody>
						
					</tbody>
				</table>
				

				<form id="form_update" autocomplete="off" style="gap: 10px">
					<hr />

					<div class="row">
						<div class="form-group col-lg-4 col-md-6">
							<label for="Id_Update">Id</label>
							<input type="text" readonly class="form-control" id="Id_Update" name="Id" placeholder="Enter Id"/>
						</div>
						<div class="form-group col-lg-4 col-md-6">
							<label for="Name_Update">Name</label>
							<input type="text" class="form-control" id="Name_Update" name="Name" placeholder="Enter Name"/>
						</div>
					
						<div class="form-group col-lg-4 col-md-6">
							<label for="City_Update">City</label>
							<select class="form-control" id="City_Update" name="City" placeholder="Select City">

							</select>
						</div>
						<div class="form-group col-lg-4 col-md-6">
							<label for="State_Update">State</label>
							<select class="form-control" id="State_Update" name="State" placeholder="Select State">

							</select>
						</div>
						<div class="form-group col-lg-4 col-md-6">
							<label for="Country_Update">Country</label>
							<select class="form-control" id="Country_Update" name="Country" placeholder="Select Country">

							</select>
						</div>
						<div class="m-2 col-sm-12 text-center">
							<button type="button" id="form_update_close" class="btn btn-danger">Close</button>
							<button type="submit" class="btn btn-success">Save</button>
						</div>
					</div>
				</form>

			</div>
		</div>
	</div>

</div>
@section Scripts {

<script>

// Definition

var baseUrl = "https://localhost:44310/api/";
var publishers = [];
var selectedItem = null;
var selectedIndex = -1;

var getAllPublisher = function() {

	$("#table_items").show();
    $("#loading").show();

	$.get(baseUrl + "Publishers", function(data, status)
	{
        if (status == "success") {
			$("#loading").hide(0.5);
            publishers = data;
            console.log(publishers);
            renderItems(publishers);
        }
        else {
            alert(data);
		}
	});

}

var renderItems = function(dataset) {
            
    let dataRow = "";
	
	dataset.forEach((item, idx) => {
        dataRow += 
		`
		<tr id="${item.id}">
			<td>${item.id}</td>
			<td>${item.name}</td>
			<td>${item.city.name}</td>
			<td>${item.state.name}</td>
			<td>${item.country.name}</td>
			<td>
				<button name="btn-update" class="btn btn-success m-1" value="${idx}">Edit</button>
				<button name="btn-delete" class="btn btn-danger m-1" value="${idx}">Remove</button>
			</td>
		<tr>
		`;
    });

    $("#table_items tbody").html(dataRow);
    addFillDataEvent();

}

var addFillDataEvent = () => {
	$("button[name='btn-update']").click(updateBtnClicked);
	$("button[name='btn-delete']").click(deleteBtnClicked);
}

var updateBtnClicked = (e) => {

    console.log("update clicked!");
    let idx = e.currentTarget.value;
    selectedItem = publishers[idx];
    selectedIndex = idx;

    fillInfo(selectedItem);

	$("#form_update").show(0.8);
    $("#form_create").hide(0.8);
}

var fillInfo = function(item) {
    $("#Id_Update").val(item.id);
    $("#Name_Update").val(item.name);
    $("#City_Update").val(item.city.id);
    $("#State_Update").val(item.state.id);
    $("#Country_Update").val(item.country.id);
};

var deleteBtnClicked = (e) => {
	console.log("delete clicked!");
            
	let idx = e.currentTarget.value;
	let deleteSelectedItem = publishers[idx];

    if (confirm(`Delete publisher with Id=${deleteSelectedItem.id}? You cannot reverse data!`)) {
				
		$.ajax({
		type: 'delete',
        headers: {
			"Content-Type": "application/json"
		},
		url: baseUrl + "Publishers" + "/" + deleteSelectedItem.id,
		success: function () {
			alert('Request was successful.');
            if (deleteSelectedItem === selectedItem) {
				selectedItem = null;
				selectedIndex = -1;
			}
            $(`#${deleteSelectedItem.id}`).hide(1);
		},
		error: function (data) {
			alert('An error occurred: ' + err.responseText);
			console.log(err.responseText);
		},
	});
	}
}

var getOptions = function(endpoint, DOM) {

	$.get(baseUrl + "AppTypes/" + endpoint, function(data, status)
	{
        if (status == "success") {
            console.log(data);
            filloptionsToSelectBox(DOM, data);
        }
        else {
            alert(data.responseText);
		}
	});
}

var filloptionsToSelectBox = function(DOM, dataset) {
    
	let dataRow = "";

	dataset.forEach((option, idx) => {
        dataRow += 
		`
		<option value=${option.id}>${option.name}</option>
		`;
    });

    DOM.append(dataRow);
}

$("#btn-refresh").click(getAllPublisher);

$("#form_update_close").click(() => {
    $("#form_update").hide(1);
})

$("#btn-create").click(() => {

	$("#form_create").show(1);
});

$("#form_create_close").click(() => {
    $("#form_create").hide(1);
})



var Init = function() {
	$("#loading").hide();
    $("#table_items").hide();
    $("#form_update").hide();
    $("#form_create").hide();

    getAllPublisher();
    getOptions("GetCities", $("select[name='City']"));
    getOptions("GetStates", $("select[name='State']"));
    getOptions("GetCountries", $("select[name='Country']"));
}

Init();

</script>

}